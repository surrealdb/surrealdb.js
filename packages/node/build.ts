import dedent from "dedent";
import { rolldown } from "rolldown";
import { name, version } from "./package.json";

// Build the NAPI binary
console.log("ðŸ”¨ Building the NAPI binary");

const DTS_HEADER = dedent`
	/* auto-generated by NAPI-RS */
	/* eslint-disable */
	type CapabilitiesAllowDenyList = {
		allow?: boolean | string[];
		deny?: boolean | string[];
	};

	type ConnectionOptions = {
		strict?: boolean;
		query_timeout?: number;
		transaction_timeout?: number;
		capabilities?:
			| boolean
			| {
				scripting?: boolean;
				guest_access?: boolean;
				live_query_notifications?: boolean;
				functions?: boolean | string[] | CapabilitiesAllowDenyList;
				network_targets?: boolean | string[] | CapabilitiesAllowDenyList;
				experimental?: boolean | string[] | CapabilitiesAllowDenyList;
			};
	};
	\n
`;

await Bun.spawn(
    [
        "bunx",
        "napi",
        "build",
        "-s",
        "--esm",
        "--dts-header",
        DTS_HEADER,
        "--platform",
        "--release",
        "--features",
        "kv-rocksdb,kv-mem",
        "-o",
        "napi",
    ],
    {
        stdout: "inherit",
        stderr: "inherit",
    },
).exited;

// Bundle the engine implementation
console.log("ðŸ”¨ Generating the package bundle");

const bundle = await rolldown({
    input: "./src-ts/index.ts",
    external: ["surrealdb", "node:module"],
});

// ESModule only (we require top level await)
await bundle.write({
    format: "esm",
    file: "./dist/surrealdb-node.mjs",
});

// JSR Configuration
await Bun.write(
    "jsr.json",
    JSON.stringify(
        {
            version,
            name,
            exports: "./dist/surrealdb-node.mjs",
            publish: {
                include: ["dist/**/*", "napi/**/*"],
            },
        },
        null,
        2,
    ),
);

// TS Declaration
const task = Bun.spawn(
    [
        "bunx",
        "dts-bundle-generator",
        "--project",
        "tsconfig.types.json",
        "--no-check",
        "--disable-symlinks-following",
        "--export-referenced-types",
        "false",
        "-o",
        "./dist/surrealdb-node.d.ts",
        "./src-ts/index.ts",
    ],
    {
        stdout: "inherit",
        stderr: "inherit",
        async onExit(_, exitCode) {
            if (exitCode !== 0) process.exit(exitCode);
        },
    },
);

await task.exited;
